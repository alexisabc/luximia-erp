server {
  listen 80;
  server_name localhost;

  # Ocultar versión de Nginx
  server_tokens off;

  # Compresión Gzip para mejorar rendimiento
  gzip on;
  gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
  gzip_vary on;
  gzip_min_length 1024;

  # Headers de Seguridad
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;

  # Seguridad de Cookies (XSS & CSRF)
  # Forzar HttpOnly evita que JavaScript acceda a las cookies (Anti-XSS).
  # SameSite=Lax protege contra CSRF manteniendo usabilidad.
  proxy_cookie_flags ~ httponly samesite=lax;
  # Nota: Para forzar 'Secure' (HTTPS), descomentar la siguiente línea (romperá auth en localhost http):
  # proxy_cookie_flags ~ secure; 

  
  # Proxy Inverso para Next.js (Standalone)
  location / {
    # Apunta al puerto donde corre Next.js (por defecto 3000).
    # En Docker (mismo container/network host): localhost:3000
    # En Docker (servicio separado): frontend:3000 (ajustar según setup)
    proxy_pass http://localhost:3000;
    
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;

    # Timeouts para evitar cortes en SSR lentos
    proxy_read_timeout 60s;
    proxy_connect_timeout 60s;
  }

  # Configuración para servir archivos estáticos con caché (si NGINX tiene acceso al volumen)
  # Si es puro proxy, Next.js servirá estos archivos, pero podemos intentar configurar caché en la respuesta
  location ~* \.(?:css|js|jpg|jpeg|gif|png|ico|svg|woff|woff2|ttf|eot)$ {
    proxy_pass http://localhost:3000;
    proxy_cache_bypass $http_upgrade;
    
    # Forzar headers de caché en el cliente
    expires 1y;
    access_log off;
    add_header Cache-Control "public";
  }

  # Deshabilitar acceso a archivos ocultos (ej. .git)
  location ~ /\. {
      deny all;
      access_log off;
      log_not_found off;
  }
}