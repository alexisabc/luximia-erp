# üöÄ Sistema ERP V2.0 - Configuraci√≥n Din√°mica

**Versi√≥n:** 2.0.0 Beta  
**Fecha:** 2026-01-03  
**Estado:** ‚úÖ Backend Completado

---

## üéØ Objetivo

Implementar un sistema de configuraci√≥n din√°mica que permita modificar el comportamiento del ERP sin tocar c√≥digo, compitiendo con funcionalidades de **Contpaqi**, **Enkontrol** y **SICAR**.

---

## ‚úÖ IMPLEMENTACI√ìN COMPLETADA

### üì¶ Modelos (TAREA 1)

#### `SystemSetting` - Configuraci√≥n del Sistema
```python
{
    'key': 'POS_ALLOW_NEGATIVE_STOCK',
    'value': False,  # JSONField (bool, string, int, dict, list)
    'category': 'POS',  # FISCAL, POS, INVENTARIO, RRHH, SECURITY
    'description': 'Permitir ventas con stock negativo',
    'is_public': False,  # Si se env√≠a al frontend
}
```

**Caracter√≠sticas:**
- ‚úÖ Cache autom√°tico (15 minutos)
- ‚úÖ Invalidaci√≥n autom√°tica al guardar/eliminar
- ‚úÖ Auditor√≠a completa (qui√©n, cu√°ndo)
- ‚úÖ Categorizaci√≥n para organizaci√≥n
- ‚úÖ Valores p√∫blicos para frontend

#### `FeatureFlag` - Control de Funcionalidades
```python
{
    'code': 'MODULE_OBRAS',
    'name': 'M√≥dulo de Obras y Construcci√≥n',
    'is_active': False,
    'rollout_percentage': 100,  # Para A/B testing
    'allowed_users': [],  # Usuarios espec√≠ficos
    'allowed_roles': ['ADMIN'],  # Roles permitidos
}
```

**Caracter√≠sticas:**
- ‚úÖ Activaci√≥n/desactivaci√≥n de m√≥dulos
- ‚úÖ Rollout gradual (0-100%)
- ‚úÖ Permisos por usuario/rol
- ‚úÖ A/B testing integrado

---

### üîß ConfigService (TAREA 2)

#### M√©todos Principales

**1. `get_value(key, default=None)`**
```python
# Obtiene configuraci√≥n con cache
allow_negative = ConfigService.get_value('POS_ALLOW_NEGATIVE_STOCK', False)
if not allow_negative:
    raise ValueError("Stock insuficiente")
```

**2. `set_value(key, value, ...)`**
```python
# Guarda configuraci√≥n
ConfigService.set_value(
    'POS_ALLOW_NEGATIVE_STOCK', 
    True, 
    category='POS',
    description='Permite ventas con stock negativo',
    modified_by=request.user
)
```

**3. `is_feature_enabled(code, user=None)`**
```python
# Verifica feature flag
if ConfigService.is_feature_enabled('MODULE_OBRAS', request.user):
    # Mostrar m√≥dulo de obras
    pass
```

**4. `get_public_settings()`**
```python
# Para enviar al frontend
{
    'POS_FAST_MODE': False,
    'FISCAL_DEFAULT_TAX_RATE': 0.16,
    'INVENTORY_MULTI_WAREHOUSE': True,
}
```

**Caracter√≠sticas:**
- ‚úÖ Cache Redis de 15 minutos
- ‚úÖ Thread-safe
- ‚úÖ Logging completo
- ‚úÖ Manejo robusto de errores

---

### üå± Seed Inicial (TAREA 3)

**Comando:** `python manage.py init_settings`

#### Configuraciones Creadas (30+)

**Fiscales (Estilo Contpaqi):**
- `FISCAL_RFC_VALIDATION` - Validar formato de RFC
- `FISCAL_AUTO_CALCULATE_TAX` - Calcular impuestos autom√°ticamente
- `FISCAL_DEFAULT_TAX_RATE` - Tasa de IVA (16%)
- `FISCAL_ALLOW_BACKDATED_INVOICES` - Facturas con fecha anterior

**Inventario (Estilo Enkontrol):**
- `INVENTORY_MULTI_WAREHOUSE` - M√∫ltiples almacenes
- `INVENTORY_ALLOW_NEGATIVE_STOCK` - Stock negativo
- `INVENTORY_COST_METHOD` - M√©todo de costeo (PROMEDIO, PEPS, UEPS)
- `INVENTORY_ENABLE_LOTS` - Gesti√≥n por lotes

**POS (Estilo SICAR):**
- `POS_FAST_MODE` - Modo r√°pido con UI simplificada
- `POS_ALLOW_NEGATIVE_STOCK` - Ventas con stock negativo
- `POS_AUTO_PRINT_TICKET` - Imprimir ticket autom√°ticamente
- `POS_MAX_DISCOUNT_PERCENTAGE` - Descuento m√°ximo sin autorizaci√≥n
- `POS_REQUIRE_SUPERVISOR_CANCELLATION` - Autorizaci√≥n para cancelar

**RRHH:**
- `RRHH_AUTO_CALCULATE_PAYROLL` - Calcular n√≥mina autom√°ticamente
- `RRHH_VACATION_DAYS_PER_YEAR` - D√≠as de vacaciones
- `RRHH_ENABLE_OVERTIME` - Habilitar horas extras

**Seguridad:**
- `SECURITY_REQUIRE_2FA` - Autenticaci√≥n de dos factores
- `SECURITY_SESSION_TIMEOUT_MINUTES` - Timeout de sesi√≥n
- `SECURITY_MAX_LOGIN_ATTEMPTS` - Intentos m√°ximos de login

#### Feature Flags Creados (6)

- `MODULE_OBRAS` - M√≥dulo de Obras (inactivo)
- `MODULE_CRM` - M√≥dulo de CRM (inactivo)
- `MODULE_ECOMMERCE` - E-Commerce (inactivo)
- `FEATURE_AI_ASSISTANT` - Asistente IA (activo)
- `FEATURE_ADVANCED_REPORTS` - Reportes BI (50% rollout)
- `FEATURE_MOBILE_APP` - App m√≥vil (inactivo)

---

### üåê API & Endpoints (TAREA 4)

#### Endpoints P√∫blicos

**GET `/api/core/config/public/`**
```json
{
    "settings": {
        "POS_FAST_MODE": false,
        "FISCAL_DEFAULT_TAX_RATE": 0.16,
        "INVENTORY_MULTI_WAREHOUSE": true
    },
    "features": {
        "MODULE_OBRAS": false,
        "FEATURE_AI_ASSISTANT": true
    }
}
```

#### Endpoints de Configuraci√≥n

**CRUD Settings:**
- `GET /api/core/settings/` - Listar todas
- `POST /api/core/settings/` - Crear nueva
- `GET /api/core/settings/{id}/` - Obtener espec√≠fica
- `PUT /api/core/settings/{id}/` - Actualizar completa
- `PATCH /api/core/settings/{id}/` - Actualizar parcial
- `DELETE /api/core/settings/{id}/` - Eliminar

**Acciones Especiales:**
- `PATCH /api/core/settings/{id}/update_value/` - Solo actualizar valor
- `POST /api/core/settings/bulk_update/` - Actualizar m√∫ltiples

**CRUD Feature Flags:**
- `GET /api/core/features/` - Listar todos
- `POST /api/core/features/` - Crear nuevo
- `GET /api/core/features/{id}/` - Obtener espec√≠fico
- `PUT /api/core/features/{id}/` - Actualizar completo
- `PATCH /api/core/features/{id}/` - Actualizar parcial
- `DELETE /api/core/features/{id}/` - Eliminar

**Acciones Especiales:**
- `POST /api/core/features/{id}/toggle/` - Activar/desactivar
- `GET /api/core/features/{id}/check/` - Verificar para usuario

---

### üé® Admin Django

**SystemSettingAdmin:**
- ‚úÖ Lista con preview de valores
- ‚úÖ Filtros por categor√≠a y visibilidad
- ‚úÖ B√∫squeda por key y descripci√≥n
- ‚úÖ Fieldsets organizados
- ‚úÖ Auditor√≠a visible

**FeatureFlagAdmin:**
- ‚úÖ Estado visual con emojis (‚úÖ/‚ùå)
- ‚úÖ Filtros por estado
- ‚úÖ Gesti√≥n de usuarios permitidos
- ‚úÖ Configuraci√≥n de rollout
- ‚úÖ Auditor√≠a completa

---

### üí° Ejemplo de Uso Real

**VentaService con ConfigService:**

```python
from core.services.config_service import ConfigService

class VentaService:
    @staticmethod
    def crear_venta_pos(turno, items, ...):
        for item in items:
            prod = get_object_or_404(Producto, pk=item['producto_id'])
            qty = Decimal(str(item['cantidad']))
            
            # V2.0: Validar stock negativo seg√∫n configuraci√≥n
            allow_negative = ConfigService.get_value('POS_ALLOW_NEGATIVE_STOCK', False)
            if not allow_negative and prod.stock_actual < qty:
                raise ValueError(
                    f"Stock insuficiente para {prod.nombre}. "
                    f"Disponible: {prod.stock_actual}, Solicitado: {qty}"
                )
            
            # Continuar con la venta...
```

**Resultado:**
- ‚úÖ Comportamiento configurable sin tocar c√≥digo
- ‚úÖ Cache para performance
- ‚úÖ Valor por defecto si no existe la config
- ‚úÖ F√°cil de modificar desde admin o API

---

## üìä Estad√≠sticas

| M√©trica | Valor |
|---------|-------|
| Modelos creados | 2 |
| Servicios creados | 1 |
| Endpoints API | 15+ |
| Configuraciones por defecto | 30+ |
| Feature flags | 6 |
| Archivos creados | 11 |
| L√≠neas de c√≥digo | ~1,400 |

---

## üéØ Pr√≥ximos Pasos (Frontend)

### ConfigContext (React)
```javascript
// contexts/ConfigContext.js
const ConfigContext = createContext();

export function ConfigProvider({ children }) {
    const [config, setConfig] = useState({});
    const [features, setFeatures] = useState({});
    
    useEffect(() => {
        // Cargar configuraciones al iniciar
        fetch('/api/core/config/public/')
            .then(res => res.json())
            .then(data => {
                setConfig(data.settings);
                setFeatures(data.features);
            });
    }, []);
    
    return (
        <ConfigContext.Provider value={{ config, features }}>
            {children}
        </ConfigContext.Provider>
    );
}
```

### UI Admin Panel
```javascript
// app/configuracion/panel/page.jsx
export default function ConfigPanel() {
    const [settings, setSettings] = useState([]);
    
    // Agrupar por categor√≠a
    const grouped = groupBy(settings, 'category');
    
    return (
        <div>
            {Object.entries(grouped).map(([category, items]) => (
                <CategorySection key={category} title={category}>
                    {items.map(setting => (
                        <ToggleSwitch
                            key={setting.key}
                            label={setting.description}
                            value={setting.value}
                            onChange={(value) => updateSetting(setting.id, value)}
                        />
                    ))}
                </CategorySection>
            ))}
        </div>
    );
}
```

---

## üèÜ Ventajas Competitivas

### vs Contpaqi
- ‚úÖ Configuraci√≥n m√°s flexible (JSON vs columnas fijas)
- ‚úÖ API REST moderna
- ‚úÖ Cache inteligente
- ‚úÖ Feature flags para m√≥dulos opcionales

### vs Enkontrol
- ‚úÖ Multi-almac√©n configurable
- ‚úÖ M√©todos de costeo din√°micos
- ‚úÖ Gesti√≥n por lotes opcional

### vs SICAR
- ‚úÖ Modo r√°pido configurable
- ‚úÖ Reglas de negocio personalizables
- ‚úÖ Sin necesidad de recompilar

---

## üìù Comandos √ötiles

```bash
# Inicializar configuraciones
python manage.py init_settings

# Crear migraciones
python manage.py makemigrations core

# Aplicar migraciones
python manage.py migrate

# Acceder al admin
http://localhost:8000/admin/core/systemsetting/
http://localhost:8000/admin/core/featureflag/
```

---

## ‚úÖ Checklist de Implementaci√≥n

- [x] Modelos de configuraci√≥n
- [x] ConfigService con cache
- [x] Seed inicial
- [x] API REST completa
- [x] Admin Django
- [x] Ejemplo de uso en VentaService
- [ ] ConfigContext en frontend
- [ ] UI Admin Panel
- [ ] Documentaci√≥n de usuario
- [ ] Tests unitarios

---

**Estado:** ‚úÖ **Backend 100% Completado**  
**Pr√≥ximo:** Frontend (ConfigContext y UI Admin)

---

**Documento generado:** 2026-01-03  
**Versi√≥n:** 2.0.0 Beta
